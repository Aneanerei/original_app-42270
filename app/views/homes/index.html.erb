
<% if flash[:notice] %>
  <div class="notice-messages">
    <ul>
      <li><%= flash[:notice] %></li>
    </ul>
  </div>
<% end %>

<% if flash[:alert] %>
  <div class="error-messages">
    <ul>
      <li><%= flash[:alert] %></li>
    </ul>
  </div>
<% end %>


<div class="book">
  <!-- 左ページ -->
  <div class="page left-page">
<%= render 'shared/book_style_layout' %>
    <div class="tab-content">
  
  <div id="calendar-selects">
  <%= form_with url: root_path, method: :get, local: true, html: { class: "inline-form" } do %>
    <%= select_tag :year, options_for_select((2020..2100).to_a, @date.year) %>
    <%= select_tag :month, options_for_select((1..12).to_a, @date.month) %>
    <%= submit_tag "表示" %>
  <% end %>
  </div>

  <!-- カレンダー表示 -->
<div class="calendar-wrapper">
  <%= month_calendar start_date: @date do |date| %>
    <div>
      <%= date.day %>
      <% if @grouped_incomes[date] %>
        <% total_income = @grouped_incomes[date].sum(&:amount) %>
        <div class="income">+<%= number_with_delimiter(total_income) %>円</div>
      <% end %>
      
      <% if @grouped_expenses[date] %>
        <% total_income = @grouped_expenses[date].sum(&:amount) %>
        <div class="expense">-<%= number_with_delimiter(total_income) %>円</div>
      <% end %>
      
      <% if @grouped_work_times[date] %>
        <% total_minutes = @grouped_work_times[date].sum(&:minutes) %>
        <% total_hours = (total_minutes / 60.0).round(2) %>
        <div class="labor">🕒 <%= total_hours %>h</div>
        
      <% end %>
    </div>
  <% end %>
</div>

<!-- カスタムモーダル -->
<div id="customDeleteModal" class="custom-modal">
  <div class="custom-modal-content">
    <p>本当に削除しますか？</p>
    <div class="modal-buttons">
      <button type="button" onclick="closeDeleteModal()">キャンセル</button>
      <button type="button" onclick="submitDeleteForm()">削除</button>
    </div>
  </div>
</div>

<div class="goal-main">
<div class="work-box">
  <div class="small-heading">今月の労働時間一覧</div>
  <% if @work_times.any? %>
  <ul class="worktime-list">
    <% @work_times.each do |work_time| %>
      <li>
        <%= work_time.date.strftime('%m/%d') %> :
       <span class="category-label">
  <%= work_time.category_work_time&.name || '未設定' %>
</span>
        /<%= (work_time.minutes / 60.0).round(2) %>h
   

  <div class="tooltip-wrapper">
    <%= form_with url: work_time_path(work_time), method: :delete, html: { class: "delete-form", style: "display: inline;" } do %>
      <button type="button" class="delete-link-button" onclick="confirmDelete(this)">
        ×<span class="tooltip-text">削除</span>
      </button>
    <% end %>
  </div>

  <div class="tooltip-wrapper">
    <%= link_to edit_work_time_path(work_time), class: "edit-link-button" do %>
      <span class="mirrored-icon">✎</span><span class="tooltip-text">編集</span>
    <% end %>
  </div>
       <% end %>
  </ul>
  <% else %>
  <p>今月の労働時間は登録されていません。</p>
  <% end %>
  </div>
  </div> 
  </div>
 

<div class="work-box">

<div class="goal-meter">
  <h3>収入目標達成率</h3>
  <div class="meter-outer">
    <div class="meter-bar income" style="width: <%= @income_progress %>%;">
      <%= @income_progress %>%（<%= number_to_currency(@income_total) %> / <%= number_to_currency(@income_goal) %>）
    </div>
    <div class="meter-marker-100"></div>
  </div>
</div>

<div class="goal-meter">
  <h3>貯金目標達成率</h3>
  <div class="meter-outer">
    <div class="meter-bar saving" style="width: <%= @savings_progress %>%;">
      <%= @savings_progress %>%（<%= number_to_currency(@actual_saving) %> / <%= number_to_currency(@savings_goal) %>）
    </div>
    <div class="meter-marker-100"></div>
  </div>
</div>

 </div>
 </div>








  <!-- 右ページ -->
  <div class="page">
     <h2><%= @date.strftime("%Y年%m月") %>の家計簿</h2>
  <!-- 今月の収支 -->
  <div class="show-box ">
  <div class="balance-box">
    <h3>収入</h3>
    <% if @incomes.any? %>
      <ul>
        <% @incomes.each do |income| %>
          <li><%= income.date.strftime("%m/%d") %>：<%= income.category_income&.name || "カテゴリ" %> / ¥<%= number_with_delimiter(income.amount) %>
   
   <div class="tooltip-wrapper">
   <!-- 削除ボタン -->
   <%= form_with url: income_path(income), method: :delete, html: { class: "delete-form", style: "display: inline;" } do %>
    <button type="button" class="delete-link-button" onclick="confirmDelete(this)">
      ×<span class="tooltip-text">削除</span>
    </button>
    <% end %>
   </div>  
  
   <!-- 編集ボタン -->
   <div class="tooltip-wrapper">
   <%= link_to edit_income_path(income), class: "edit-link-button" do %> 
  <span class="mirrored-icon">✎</span><span class="tooltip-text">編集</span>
   <% end %>
  </div>  

      </li>
        <% end %>
      </ul>
    <% else %>
      <p>この月の収入はありません</p>
    <% end %>
  </div>

  <div class="balance-box">
    <h3>支出</h3>
    <% if @expenses.any? %>
      <ul>
        <% @expenses.each do |expense| %>
          <li><%= expense.date.strftime("%m/%d") %>：<%= expense.category_expense&.name || "カテゴリ" %> / ¥<%= number_with_delimiter(expense.amount) %>
      <div class="tooltip-wrapper">
   
   <!-- 削除ボタン -->
   <%= form_with url: expense_path(expense), method: :delete, html: { class: "delete-form", style: "display: inline;" } do %>
    <button type="button" class="delete-link-button" onclick="confirmDelete(this)">
      ×<span class="tooltip-text">削除</span>
   </button>
    <% end %>
   </div>       
   
   <!-- 編集ボタン -->
   <div class="tooltip-wrapper">
   <%= link_to edit_expense_path(expense), class: "edit-link-button" do %> 
  <span class="mirrored-icon">✎</span><span class="tooltip-text">編集</span>
   <% end %>
  </div>          
      </li>
        <% end %>
      </ul>
    <% else %>
      <p>この月の支出はありません</p>
    <% end %>
  </div>
  </div>

<!-- 月間集計セクション -->
<div class="summary-box <%= @balance >= 0 ? 'summary-positive' : 'summary-negative' %>">
<h3 class="summary-heading">今月の集計</h3>
<div class="summary-row">
<div class="summary-item">
  <div class="summary-label">収入</div>
  <div class="summary-value balance-positive">＋¥<%= number_with_delimiter(@total_income) %></div>
</div>
  <div class="summary-item">
    <div class="summary-label">支出</div>
    <div class="summary-value balance-negative">－¥<%= number_with_delimiter(@total_expense) %></div>
  </div>
 <div class="summary-item">
  <div class="summary-label">合計</div>
  <div class="summary-value <%= @balance >= 0 ? 'balance-positive' : 'balance-negative' %>">
    <%= @balance >= 0 ? "＋" : "－" %>¥<%= number_with_delimiter(@balance.abs) %>
  </div>
</div>
</div>
</div>
<div class="show-box ">
  <div class="balance-box">
    <h2>今月のカテゴリ別収入</h2>
    <ul>
<% if @income_summary.present? %>
  <% @income_summary.to_a.each_with_index do |(category, amount), index| %>
    <% rank_class = case index
      when 0 then "rank-1"
      when 1 then "rank-2"
      when 2 then "rank-3"
      else "rank-default"
    end %>

    <div class="category-box <%= rank_class %>">
      <span class="rank-number">No.<%= index + 1 %></span>
      <span class="category-name"><%= category %></span>
      <span class="category-amount"><%= number_to_currency(amount, unit: "円") %></span>
    </div>
  <% end %>
<% else %>
  <p>収入データがありません。</p>
<% end %>
    </ul>
  </div>
  <div class="balance-box">
  <h2>今月のカテゴリ別支出</h2>
    <ul>
  <% if @expense_summary.present? %>
  <% @expense_summary.to_a.each_with_index do |(category, amount), index| %>
    <% rank_class = case index
      when 0 then "expense-rank-1"
      when 1 then "expense-rank-2"
      when 2 then "expense-rank-3"
      else "expense-rank-default"
    end %>

    <div class="category-box <%= rank_class %>">
      <span class="rank-number">No.<%= index + 1 %></span>
      <span class="category-name"><%= category %></span>
      <span class="category-amount"><%= number_to_currency(amount, unit: "円") %></span>
    </div>
  <% end %>
<% else %>
  <p>支出データがありません。</p>
<% end %>
    </ul>
  </div>
</div>

</div>
</div>
</div>
</div>
<!-- 目標設定モーダル -->
<div id="goal-modal" class="modal-overlay" style="display: none;">
  <div class="modal-content">
    <h2>今月の目標設定</h2>

    <%= form_with model: MonthlyGoal.new, url: monthly_goals_path, local: true do |f| %>
      <%= hidden_field_tag :year, Date.today.year %>
      <%= hidden_field_tag :month, Date.today.month %>

      <div class="form-group">
        <%= f.label :income_goal, "収入目標額" %>
        <%= f.number_field :income_goal, class: "form-control" %>
      </div>

      <div class="form-group">
        <%= f.label :savings_goal, "貯金目標額" %>
        <%= f.number_field :savings_goal, class: "form-control" %>
      </div>

      <div class="form-actions">
        <%= f.submit "保存", class: "form-submit" %>
        <button type="button" onclick="closeGoalModal()" class="form-button">キャンセル</button>
      </div>
    <% end %>
  </div>
</div>